{% extends "layout/base.html" %}

{% block title %}Calendário{% endblock %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.css' rel='stylesheet' />
<style>
.calendar-sidebar {
    border-right: 1px solid var(--bs-border-color);
    height: calc(100vh - 150px);
    overflow-y: auto;
}

.main-calendar {
    height: calc(100vh - 150px);
    overflow-y: auto;
}

.mini-calendar {
    font-size: 0.8em;
}

.upcoming-events {
    margin-top: 1rem;
}

.upcoming-event-item {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    border-bottom: 1px solid var(--bs-border-color);
}

.upcoming-event-item:hover {
    background-color: var(--bs-secondary-bg-subtle);
}

.event-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 0.5rem;
}

.event-info {
    flex: 1;
}

.event-title {
    font-weight: 500;
}

.event-date {
    font-size: 0.8em;
    color: var(--bs-secondary-color);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid h-100">
    <div class="row h-100">
        <!-- Sidebar do Calendário -->
        <div class="col-md-3 calendar-sidebar">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Eventos</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#eventModal">
                    <i class="fas fa-plus"></i> Novo Evento
                </button>
            </div>

            <!-- Mini Calendário -->
            <div class="mini-calendar mb-3" id="miniCalendar"></div>

            <!-- Lista de Próximos Eventos -->
            <div class="upcoming-events">
                <h6 class="mb-3">Próximos Eventos</h6>
                <div id="upcomingEventsList">
                    <!-- Eventos serão preenchidos via JavaScript -->
                </div>
            </div>
        </div>

        <!-- Calendário Principal -->
        <div class="col-md-9 main-calendar">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<!-- Modal de Evento -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Evento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <div class="mb-3">
                        <label class="form-label">Título</label>
                        <input type="text" class="form-control" id="eventTitle" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrição</label>
                        <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Data Início</label>
                            <input type="datetime-local" class="form-control" id="eventStart" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Data Fim</label>
                            <input type="datetime-local" class="form-control" id="eventEnd" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Cor</label>
                        <select class="form-select" id="eventColor">
                            <option value="#2563eb">Azul</option>
                            <option value="#16a34a">Verde</option>
                            <option value="#dc2626">Vermelho</option>
                            <option value="#ca8a04">Amarelo</option>
                            <option value="#9333ea">Roxo</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveEvent()">Salvar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/pt-br.js'></script>
<script>
let calendar;
let miniCalendar;
let currentEvent = null;

document.addEventListener('DOMContentLoaded', function() {
    // Inicialização do Calendário Principal
    const calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'pt-br',
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        editable: true,
        selectable: true,
        selectMirror: true,
        dayMaxEvents: true,
        eventClick: function(info) {
            currentEvent = info.event;
            showEventModal(info.event);
        },
        select: function(info) {
            currentEvent = null;
            const modal = new bootstrap.Modal(document.getElementById('eventModal'));
            document.getElementById('eventStart').value = info.startStr;
            document.getElementById('eventEnd').value = info.endStr;
            modal.show();
        },
        eventDrop: function(info) {
            updateEvent(info.event);
        },
        eventResize: function(info) {
            updateEvent(info.event);
        }
    });
    calendar.render();

    // Inicialização do Mini Calendário
    const miniCalendarEl = document.getElementById('miniCalendar');
    miniCalendar = new FullCalendar.Calendar(miniCalendarEl, {
        locale: 'pt-br',
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev',
            center: 'title',
            right: 'next'
        },
        height: 'auto',
        dateClick: function(info) {
            calendar.gotoDate(info.date);
        }
    });
    miniCalendar.render();

    // Carregar eventos iniciais
    loadEvents();
});

function showEventModal(event = null) {
    const modal = new bootstrap.Modal(document.getElementById('eventModal'));
    const title = document.getElementById('eventTitle');
    const description = document.getElementById('eventDescription');
    const start = document.getElementById('eventStart');
    const end = document.getElementById('eventEnd');
    const color = document.getElementById('eventColor');

    if (event) {
        title.value = event.title;
        description.value = event.extendedProps.description || '';
        start.value = event.start ? event.start.toISOString().slice(0, 16) : '';
        end.value = event.end ? event.end.toISOString().slice(0, 16) : '';
        color.value = event.backgroundColor || '#2563eb';
        document.querySelector('.modal-title').textContent = 'Editar Evento';
    } else {
        title.value = '';
        description.value = '';
        start.value = '';
        end.value = '';
        color.value = '#2563eb';
        document.querySelector('.modal-title').textContent = 'Novo Evento';
    }

    modal.show();
}

async function loadEvents() {
    try {
        const response = await fetch('/api/v1/events');
        if (!response.ok) throw new Error('Erro ao carregar eventos');
        
        const events = await response.json();
        calendar.removeAllEvents();
        calendar.addEventSource(events);
        updateUpcomingEvents();
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao carregar eventos', 'danger');
    }
}

async function saveEvent() {
    const eventData = {
        title: document.getElementById('eventTitle').value,
        description: document.getElementById('eventDescription').value,
        start: document.getElementById('eventStart').value,
        end: document.getElementById('eventEnd').value,
        color: document.getElementById('eventColor').value
    };

    if (!eventData.title || !eventData.start || !eventData.end) {
        showToast('Preencha os campos obrigatórios', 'warning');
        return;
    }

    try {
        const url = '/api/v1/events' + (currentEvent ? `/${currentEvent.id}` : '');
        const method = currentEvent ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(eventData)
        });

        if (!response.ok) throw new Error('Erro ao salvar evento');

        const savedEvent = await response.json();
        if (currentEvent) {
            currentEvent.remove();
        }
        calendar.addEvent(savedEvent);
        updateUpcomingEvents();

        const modal = bootstrap.Modal.getInstance(document.getElementById('eventModal'));
        modal.hide();
        showToast('Evento salvo com sucesso!', 'success');
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao salvar evento', 'danger');
    }
}

async function updateEvent(event) {
    try {
        const eventData = {
            title: event.title,
            description: event.extendedProps.description,
            start: event.start.toISOString(),
            end: event.end ? event.end.toISOString() : event.start.toISOString(),
            color: event.backgroundColor
        };

        const response = await fetch(`/api/v1/events/${event.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(eventData)
        });

        if (!response.ok) throw new Error('Erro ao atualizar evento');
        updateUpcomingEvents();
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao atualizar evento', 'danger');
        loadEvents(); // Recarregar eventos em caso de erro
    }
}

async function deleteEvent() {
    if (!currentEvent || !confirm('Tem certeza que deseja excluir este evento?')) return;

    try {
        const response = await fetch(`/api/v1/events/${currentEvent.id}`, {
            method: 'DELETE'
        });

        if (!response.ok) throw new Error('Erro ao excluir evento');

        currentEvent.remove();
        updateUpcomingEvents();
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('eventModal'));
        modal.hide();
        showToast('Evento excluído com sucesso!', 'success');
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao excluir evento', 'danger');
    }
}

function updateUpcomingEvents() {
    const upcomingList = document.getElementById('upcomingEventsList');
    const events = calendar.getEvents();
    const now = new Date();
    
    // Filtrar e ordenar eventos futuros
    const upcomingEvents = events
        .filter(event => event.start >= now)
        .sort((a, b) => a.start - b.start)
        .slice(0, 5);

    // Atualizar lista
    upcomingList.innerHTML = upcomingEvents.length ? 
        upcomingEvents.map(event => `
            <div class="upcoming-event-item" onclick="calendar.gotoDate('${event.start.toISOString()}')">
                <div class="event-dot" style="background-color: ${event.backgroundColor}"></div>
                <div class="event-info">
                    <div class="event-title">${event.title}</div>
                    <div class="event-date">${event.start.toLocaleDateString()}</div>
                </div>
            </div>
        `).join('') :
        '<p class="text-muted">Nenhum evento próximo</p>';
}

function showToast(message, type = 'info') {
    // Implementar toast de notificação
    alert(message);
}
</script>
{% endblock %} 