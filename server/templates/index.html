{% extends "base.html" %}

{% block title %}Chat & Notas{% endblock %}

{% block content %}
<div class="row h-100">
    <!-- Chat Section -->
    <div class="col-md-6 chat-section">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Chat</h5>
            </div>
            <div class="card-body chat-messages" id="chat-messages">
                <!-- Mensagens do chat serão inseridas aqui -->
            </div>
            <div class="card-footer">
                <form id="chat-form" class="d-flex">
                    <input type="text" id="message-input" class="form-control me-2" placeholder="Digite sua mensagem...">
                    <button type="submit" class="btn btn-primary">Enviar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Notes Section -->
    <div class="col-md-6 notes-section">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Notas Automáticas</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newNoteModal">
                    <i class="bi bi-plus-lg"></i> Nova Nota
                </button>
            </div>
            <div class="card-body notes-list" id="notes-list">
                <!-- Notas serão inseridas aqui -->
            </div>
        </div>
    </div>
</div>

<!-- Modal Nova Nota -->
<div class="modal fade" id="newNoteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Nota</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="note-form">
                    <div class="mb-3">
                        <textarea class="form-control" id="note-content" rows="4" 
                                placeholder="Digite sua nota... O sistema identificará automaticamente ações necessárias."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="save-note">Salvar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const noteForm = document.getElementById('note-form');
    const saveNoteBtn = document.getElementById('save-note');
    const notesList = document.getElementById('notes-list');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatMessages = document.getElementById('chat-messages');

    // Função para criar nota
    saveNoteBtn.addEventListener('click', async function() {
        const content = document.getElementById('note-content').value;
        if (!content) return;

        try {
            const response = await fetch('/api/notes/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content })
            });

            const result = await response.json();
            if (result.error) {
                alert('Erro ao criar nota: ' + result.error);
                return;
            }

            // Adiciona nota à lista
            addNoteToList(result);
            
            // Fecha o modal
            bootstrap.Modal.getInstance(document.getElementById('newNoteModal')).hide();
            document.getElementById('note-content').value = '';
            
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao criar nota');
        }
    });

    // Função para adicionar nota à lista
    function addNoteToList(note) {
        const noteElement = document.createElement('div');
        noteElement.className = 'note-item card mb-3';
        noteElement.innerHTML = `
            <div class="card-body">
                <p class="note-content">${note.content}</p>
                <div class="note-actions">
                    ${note.executed_actions.map(action => `
                        <span class="badge bg-${getActionBadgeColor(action.type)}">
                            ${action.type}: ${action.result}
                        </span>
                    `).join('')}
                </div>
            </div>
        `;
        notesList.prepend(noteElement);
    }

    // Função para definir cor do badge da ação
    function getActionBadgeColor(actionType) {
        const colors = {
            'reminder': 'info',
            'task': 'primary',
            'notification': 'warning'
        };
        return colors[actionType] || 'secondary';
    }

    // Função para enviar mensagem no chat
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const message = messageInput.value;
        if (!message) return;

        // Adiciona mensagem do usuário
        addMessageToChat('user', message);
        messageInput.value = '';

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message })
            });

            const result = await response.json();
            
            // Adiciona resposta do assistente
            addMessageToChat('assistant', result.response);
            
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao enviar mensagem');
        }
    });

    // Função para adicionar mensagem ao chat
    function addMessageToChat(role, content) {
        const messageElement = document.createElement('div');
        messageElement.className = `chat-message ${role}-message`;
        messageElement.innerHTML = `
            <div class="message-content">
                ${content}
            </div>
        `;
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
});
</script>
{% endblock %} 