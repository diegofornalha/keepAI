<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>KeepAI - Seu Assistente Pessoal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <style>
        /* Loading Spinner */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <!-- Se√ß√£o de Chat -->
        <div class="chat-section">
            <div class="chat-container" id="chat-container">
                <!-- Mensagens ser√£o adicionadas aqui -->
            </div>
            <div class="input-container">
                <input type="text" id="user-input" placeholder="Digite sua mensagem..." autofocus>
                <button onclick="sendMessage()">Enviar</button>
            </div>
        </div>

        <!-- Se√ß√£o de Notas -->
        <div class="notes-section">
            <div class="notes-header">
                <h2>üìù Suas Notas</h2>
                <button onclick="showCreateNoteModal()" class="new-note-btn">+ Nova Nota</button>
            </div>
            <div class="notes-container" id="notes-container">
                <!-- Notas ser√£o adicionadas aqui -->
            </div>
        </div>
    </div>

    <!-- Modal de Cria√ß√£o de Nota -->
    <div id="createNoteModal" class="modal">
        <div class="modal-content">
            <h2>Nova Nota</h2>
            <input type="text" id="noteTitle" placeholder="T√≠tulo">
            <textarea id="noteContent" placeholder="Conte√∫do"></textarea>
            <div class="modal-buttons">
                <button onclick="hideCreateNoteModal()">Cancelar</button>
                <button onclick="createNote()">Criar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Nota -->
    <div id="editNoteModal" class="modal">
        <div class="modal-content">
            <h2>Editar Nota</h2>
            <input type="text" id="editNoteTitle" placeholder="T√≠tulo">
            <textarea id="editNoteContent" placeholder="Conte√∫do"></textarea>
            <div class="modal-buttons">
                <button onclick="hideEditNoteModal()">Cancelar</button>
                <button onclick="updateNote()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Dele√ß√£o -->
    <div id="deleteNoteModal" class="modal">
        <div class="modal-content">
            <h2>Confirmar Dele√ß√£o</h2>
            <p>Tem certeza que deseja deletar esta nota?</p>
            <div class="modal-buttons">
                <button onclick="hideDeleteNoteModal()">Cancelar</button>
                <button onclick="confirmDeleteNote()" class="delete-btn">Deletar</button>
            </div>
        </div>
    </div>

    <script>
        let currentNoteId = null;
        let editingNoteId = null;

        // Configura√ß√£o do token CSRF
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        // Fun√ß√£o para formatar a data no padr√£o brasileiro
        function formatarDataBrasil(data) {
            const date = new Date(data);
            return date.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Fun√ß√£o para mostrar/esconder loading
        function showLoading() {
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            loading.style.opacity = '1';
        }
        
        function hideLoading() {
            const loading = document.getElementById('loading');
            loading.style.opacity = '0';
            setTimeout(() => {
                loading.style.display = 'none';
            }, 300);
        }

        // Fun√ß√£o para enviar mensagem com token CSRF
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            appendMessage('user', message);
            
            showLoading();
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({ message })
                });

                if (!response.ok) {
                    throw new Error('Erro na requisi√ß√£o');
                }

                const data = await response.json();
                appendMessage('assistant', data.response);
            } catch (error) {
                console.error('Erro:', error);
                appendMessage('error', 'Desculpe, ocorreu um erro ao processar sua mensagem.');
            } finally {
                hideLoading();
            }
        }

        // Fun√ß√£o para adicionar mensagem ao chat
        function appendMessage(type, content) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.textContent = content;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Fun√ß√£o para carregar notas com token CSRF
        async function loadNotes() {
            try {
                const response = await fetch('/api/notes', {
                    headers: {
                        'X-CSRF-Token': csrfToken
                    }
                });

                if (!response.ok) {
                    throw new Error('Erro ao carregar notas');
                }

                const data = await response.json();
                displayNotes(data.response);
            } catch (error) {
                console.error('Erro ao carregar notas:', error);
            }
        }

        // Fun√ß√£o para exibir as notas
        function displayNotes(notes) {
            const notesContainer = document.getElementById('notes-container');
            notesContainer.innerHTML = ''; // Limpa o container

            notes.forEach(note => {
                const noteDiv = document.createElement('div');
                noteDiv.className = 'note';
                noteDiv.innerHTML = `
                    <div class="note-header">
                        <h3>${note.titulo}</h3>
                        <div class="note-actions">
                            <button onclick="showEditNoteModal(${note.id}, '${note.titulo}', '${note.conteudo}')" class="edit-btn">‚úèÔ∏è</button>
                            <button onclick="showDeleteNoteModal(${note.id})" class="delete-btn">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="note-content">${note.conteudo}</div>
                    <div class="note-footer">
                        <span class="note-date">${formatarDataBrasil(note.data)}</span>
                    </div>
                `;
                notesContainer.appendChild(noteDiv);
            });
        }

        // Fun√ß√£o para processar texto das notas
        function processNotesText(notesText) {
            const lines = notesText.split('\n');
            let currentNote = null;
            
            for (const line of lines) {
                if (line.startsWith('#')) {
                    if (currentNote) {
                        addNoteToContainer(currentNote);
                    }
                    const match = line.match(/#(\d+) - (.*?) \((.*?)\)/);
                    if (match) {
                        currentNote = {
                            id: match[1],
                            titulo: match[2],
                            data: match[3],
                            conteudo: ''
                        };
                    }
                } else if (currentNote && line.trim()) {
                    currentNote.conteudo += line + '\n';
                }
            }
            
            if (currentNote) {
                addNoteToContainer(currentNote);
            }
        }

        // Fun√ß√£o para adicionar nota ao container
        function addNoteToContainer(note) {
            const notesContainer = document.getElementById('notes-container');
            const noteDiv = document.createElement('div');
            noteDiv.className = 'note';
            
            // Limpa o conte√∫do removendo IDs e t√≠tulo duplicado
            let cleanContent = note.conteudo;
            // Remove n√∫meros no in√≠cio do conte√∫do (IDs)
            cleanContent = cleanContent.replace(/^\d+[\s\n]*/, '');
            // Remove o t√≠tulo se ele estiver no in√≠cio do conte√∫do
            cleanContent = cleanContent.replace(new RegExp('^' + escapeRegExp(note.titulo) + '[\s\n]*'), '');
            // Remove linhas em branco extras
            cleanContent = cleanContent.trim();
            
            noteDiv.innerHTML = `
                <div class="note-header">
                    <h3>${escapeHtml(note.titulo)}</h3>
                    <div class="note-actions">
                        <button onclick="showEditNoteModal('${note.id}', '${escapeHtml(note.titulo)}', \`${escapeHtml(cleanContent)}\`)">‚úèÔ∏è</button>
                        <button onclick="showDeleteNoteModal(${note.id})">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="note-date">${formatarDataBrasil(note.data)}</div>
                <div class="note-content">${escapeHtml(cleanContent)}</div>
            `;
            notesContainer.appendChild(noteDiv);
        }

        // Fun√ß√£o para escapar HTML (preven√ß√£o XSS)
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Fun√ß√£o para escapar express√µes regulares
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Fun√ß√µes para manipula√ß√£o de notas
        function showEditNoteModal(id, title, content) {
            editingNoteId = id;
            document.getElementById('editNoteTitle').value = title;
            document.getElementById('editNoteContent').value = content;
            document.getElementById('editNoteModal').style.display = 'flex';
        }

        function hideEditNoteModal() {
            document.getElementById('editNoteModal').style.display = 'none';
            editingNoteId = null;
        }

        function showDeleteNoteModal(id) {
            currentNoteId = id;
            document.getElementById('deleteNoteModal').style.display = 'flex';
        }

        function hideDeleteNoteModal() {
            document.getElementById('deleteNoteModal').style.display = 'none';
            currentNoteId = null;
        }

        function showCreateNoteModal() {
            document.getElementById('createNoteModal').style.display = 'flex';
        }

        function hideCreateNoteModal() {
            document.getElementById('createNoteModal').style.display = 'none';
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
        }

        // Fun√ß√£o para criar nota
        async function createNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();

            if (!title || !content) {
                alert('Por favor, preencha todos os campos.');
                return;
            }

            showLoading();
            try {
                const response = await fetch('/api/notes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({
                        titulo: title,
                        conteudo: content
                    })
                });

                if (!response.ok) {
                    throw new Error('Erro ao criar nota');
                }

                hideCreateNoteModal();
                document.getElementById('noteTitle').value = '';
                document.getElementById('noteContent').value = '';
                loadNotes();
            } catch (error) {
                console.error('Erro ao criar nota:', error);
                alert('Erro ao criar nota. Por favor, tente novamente.');
            } finally {
                hideLoading();
            }
        }

        // Fun√ß√£o para atualizar nota
        async function updateNote() {
            const title = document.getElementById('editNoteTitle').value.trim();
            const content = document.getElementById('editNoteContent').value.trim();

            if (!title || !content) {
                alert('Por favor, preencha todos os campos.');
                return;
            }

            showLoading();
            try {
                const response = await fetch(`/api/notes/${editingNoteId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({
                        titulo: title,
                        conteudo: content
                    })
                });

                if (!response.ok) {
                    throw new Error('Erro ao atualizar nota');
                }

                hideEditNoteModal();
                loadNotes();
            } catch (error) {
                console.error('Erro ao atualizar nota:', error);
                alert('Erro ao atualizar nota. Por favor, tente novamente.');
            } finally {
                hideLoading();
            }
        }

        async function confirmDeleteNote() {
            if (!currentNoteId) return;

            showLoading();
            try {
                const response = await fetch(`/api/notes/${currentNoteId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRF-Token': csrfToken
                    }
                });

                if (!response.ok) {
                    throw new Error('Erro ao deletar nota');
                }

                hideDeleteNoteModal();
                loadNotes();
            } catch (error) {
                console.error('Erro ao deletar nota:', error);
                alert('Erro ao deletar nota. Por favor, tente novamente.');
            } finally {
                hideLoading();
            }
        }

        // Event listener para o Enter no input
        document.getElementById('user-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Carrega as notas ao iniciar a p√°gina
        document.addEventListener('DOMContentLoaded', loadNotes);
    </script>
</body>
</html> 